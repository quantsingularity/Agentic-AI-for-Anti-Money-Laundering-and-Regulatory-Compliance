name: CI Formatting Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  formatting_check:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # Checkout repository
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------
      # Python Setup + Caching
      # -------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python formatters
        run: pip install --upgrade pip && pip install autoflake black

      # -------------------------------
      # Run Python formatting checks (Repository-wide)
      # -------------------------------
      - name: Run Python formatting checks (Repository-wide)
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Preparing temporary copy of repository for autoflake ==="
          TMP_COPY="$(mktemp -d)"
          # Copy only .py files to temp for comparison to avoid massive IO
          rsync -am --include='*.py' --include='*/' --exclude='*' . "$TMP_COPY/"

          echo "=== Running autoflake (will modify temp copy) ==="
          autoflake \
            --remove-all-unused-imports \
            --remove-unused-variables \
            --recursive \
            --ignore-init-module-imports \
            --in-place \
            "$TMP_COPY"

          echo "=== Comparing repository .py files with autoflake-modified copy ==="
          # Compare only .py files
          if ! diff -qr . "$TMP_COPY" --include="*.py" > /dev/null; then
            echo "autoflake found formatting/unused-imports issues in Python files."
            echo "Run: autoflake --remove-all-unused-imports --remove-unused-variables --recursive --ignore-init-module-imports --in-place ."
            rm -rf "$TMP_COPY"
            exit 1
          fi

          rm -rf "$TMP_COPY"

          echo "=== Running black (check mode on all .py files) ==="
          black . --check

      # -------------------------------
      # Node + npm caching
      # -------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install Node dependencies (root)
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found, skipping npm ci."
          fi

      # -------------------------------
      # Prettier checks (Markdown & YAML)
      # -------------------------------

      - name: Run Prettier Checks (all .md files in repo)
        run: |
          echo "=== Running Prettier (all .md files) ==="
          npx --no-install prettier --check "**/*.md" --ignore-path .prettierignore || {
            echo "Prettier formatting issues detected in markdown files."
            exit 1
          }

      - name: Run Prettier Checks (all YAML/YML files in repo)
        run: |
          echo "=== Running Prettier (all .yml and .yaml files) ==="
          npx --no-install prettier --check "**/*.{yml,yaml}" --ignore-path .prettierignore || {
            echo "Prettier formatting issues detected in YAML/YML files."
            exit 1
          }

      # -------------------------------
      # Finalize
      # -------------------------------
      - name: Finalize Check
        run: echo "All repository-wide formatting checks completed successfully."
